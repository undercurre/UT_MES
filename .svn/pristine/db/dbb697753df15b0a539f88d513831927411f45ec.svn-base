<template>
  <d2-container class="siteManagerReport">
    <!-- 上 -->
    <el-row :gutter="20" style="height: 40%">
      <el-col :span="17" style="height: 100%">
        <el-tabs type="border-card" ref="bigTabs" @tab-click="ChangeBigTab">
          <el-tab-pane :label="$t('_kanban._54')">
            <el-tabs
              @tab-click="ChangeTab"
              type="card"
              ref="allTransfer"
              :style="{
                height: tableHeight,
              }"
            >
              <el-tab-pane
                class="allTransfer"
                :label="$t('_kanban._17')"
              ></el-tab-pane>
              <el-tab-pane :label="$t('_kanban._18')">
                <el-form
                  ref="form"
                  :model="formData"
                  label-width="80px"
                  :show-message="false"
                >
                  <el-form-item :label="$t('_kanban._18')">
                    <el-select
                      multiple
                      @change="changeModel"
                      v-model="formData.MODEL"
                      style="width: 100%"
                      :placeholder="$t('_kanban._19')"
                    >
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          top: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          bottom: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          width: 600px;
                          display: flex;
                          padding: 0 20px 0 10px;
                          position: sticky;
                          top: 6px;
                          background: #fff;
                          z-index: 90;
                        "
                      >
                        <el-input
                          v-model="formData.Key"
                          @input="searchClick"
                          @keyup.enter.native="searchClick"
                        ></el-input>
                        <el-button
                          type="primary"
                          icon="el-icon-search"
                          @click.prevent="searchClick"
                          >{{ $t("publics.btn.search") }}</el-button
                        >
                      </div>
                      <el-option
                        v-for="item in modelData"
                        :key="item.R"
                        :label="item.NAME"
                        :value="item.NAME"
                        :disabled="item.disabled"
                      >
                        <span style="float: left">{{ item.NAME }}</span>
                      </el-option>
                      <div
                        style="
                          width: 600px;
                          position: sticky;
                          bottom: 6px;
                          background: #fff;
                          z-index: 90;
                          padding-left: 15px;
                        "
                      >
                        <el-pagination
                          :pager-count="5"
                          :current-page="formData.Page"
                          :page-size="formData.Limit"
                          :page-sizes="[10, 20, 30, 40]"
                          layout="total, sizes, prev, pager, next, jumper"
                          :total="formDataPage"
                          @size-change="modelSizeChange"
                          @current-change="modelCurrentChange"
                        />
                      </div>
                    </el-select>
                  </el-form-item>
                </el-form>
              </el-tab-pane>
              <el-tab-pane :label="$t('_kanban._20')">
                <el-form
                  ref="form"
                  :model="formData"
                  label-width="80px"
                  :show-message="false"
                >
                  <el-form-item :label="$t('_kanban._20')">
                    <el-select
                      multiple
                      @change="changeModel"
                      v-model="formData.PART_NO"
                      style="width: 100%"
                      :placeholder="$t('_kanban._21')"
                    >
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          top: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          bottom: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          width: 600px;
                          display: flex;
                          padding: 0 20px 0 10px;
                          position: sticky;
                          top: 6px;
                          background: #fff;
                          z-index: 90;
                        "
                      >
                        <el-input
                          v-model="formData.Key"
                          @input="searchClick"
                          @keyup.enter.native="searchClick"
                        ></el-input>
                        <el-button
                          type="primary"
                          icon="el-icon-search"
                          @click.prevent="searchClick"
                          >{{ $t("publics.btn.search") }}</el-button
                        >
                      </div>
                      <el-option
                        v-for="item in modelData"
                        :key="item.ID"
                        :label="item.NAME"
                        :value="item.NAME"
                        :disabled="item.disabled"
                      >
                        <span style="float: left">{{ item.NAME }}</span>
                        <span style="float: right">{{ item.DESCRIPTION }}</span>
                      </el-option>
                      <div
                        style="
                          width: 600px;
                          position: sticky;
                          bottom: 6px;
                          background: #fff;
                          z-index: 90;
                          padding-left: 15px;
                        "
                      >
                        <el-pagination
                          :pager-count="5"
                          :current-page="formData.Page"
                          :page-size="formData.Limit"
                          :page-sizes="[10, 20, 30, 40]"
                          layout="total, sizes, prev, pager, next, jumper"
                          :total="formDataPage"
                          @size-change="modelSizeChange"
                          @current-change="modelCurrentChange"
                        />
                      </div>
                    </el-select>
                  </el-form-item>
                </el-form>
              </el-tab-pane>
              <el-tab-pane :label="$t('_kanban._22')">
                <el-form
                  ref="form"
                  :model="formData"
                  label-width="80px"
                  :show-message="false"
                >
                  <el-form-item :label="$t('_kanban._22')">
                    <el-select
                      multiple
                      @change="changeModel"
                      v-model="formData.WO_NO"
                      style="width: 100%"
                      :placeholder="$t('_kanban._23')"
                    >
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          top: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          position: absolute;
                          width: 100%;
                          height: 6px;
                          background: #fff;
                          background: #fff;
                          bottom: 0;
                          z-index: 99;
                        "
                      ></div>
                      <div
                        style="
                          width: 600px;
                          display: flex;
                          padding: 0 20px 0 10px;
                          position: sticky;
                          top: 6px;
                          background: #fff;
                          z-index: 90;
                        "
                      >
                        <el-input
                          v-model="formData.Key"
                          @input="searchClick"
                          @keyup.enter.native="searchClick"
                        ></el-input>
                        <el-button
                          type="primary"
                          icon="el-icon-search"
                          @click.prevent="searchClick"
                          >{{ $t("publics.btn.search") }}</el-button
                        >
                      </div>
                      <el-option
                        v-for="item in modelData"
                        :key="item.ID"
                        :label="item.NAME"
                        :value="item.NAME"
                        :disabled="item.disabled"
                      >
                        <span style="float: left">{{ item.NAME }}</span>
                        <span style="float: right">{{ item.PART_NO }}</span>
                      </el-option>
                      <div
                        style="
                          width: 600px;
                          position: sticky;
                          bottom: 6px;
                          background: #fff;
                          z-index: 90;
                          padding-left: 15px;
                        "
                      >
                        <el-pagination
                          :pager-count="5"
                          :current-page="formData.Page"
                          :page-size="formData.Limit"
                          :page-sizes="[10, 20, 30, 40]"
                          layout="total, sizes, prev, pager, next, jumper"
                          :total="formDataPage"
                          @size-change="modelSizeChange"
                          @current-change="modelCurrentChange"
                        />
                      </div>
                    </el-select>
                  </el-form-item>
                </el-form>
              </el-tab-pane>
            </el-tabs>
          </el-tab-pane>
          <el-tab-pane :label="$t('_kanban._55')">
            <el-form :model="formData" label-width="80px" :show-message="false">
              <el-form-item :label="'线别'">
                <el-select
                  multiple
                  @change="changeModel"
                  v-model="formData.LINE_ID"
                  style="width: 100%"
                  :placeholder="$t(' ')"
                >
                  <div
                    style="
                      position: absolute;
                      width: 100%;
                      height: 6px;
                      background: #fff;
                      background: #fff;
                      top: 0;
                      z-index: 99;
                    "
                  ></div>
                  <div
                    style="
                      position: absolute;
                      width: 100%;
                      height: 6px;
                      background: #fff;
                      background: #fff;
                      bottom: 0;
                      z-index: 99;
                    "
                  ></div>
                  <div
                    style="
                      width: 600px;
                      display: flex;
                      padding: 0 20px 0 10px;
                      position: sticky;
                      top: 6px;
                      background: #fff;
                      z-index: 90;
                    "
                  >
                    <el-input
                      v-model="formData.Key"
                      @input="searchLine"
                      @keyup.enter.native="searchLine"
                    ></el-input>
                    <el-button
                      type="primary"
                      icon="el-icon-search"
                      @click.prevent="searchLine"
                      >{{ $t("publics.btn.search") }}</el-button
                    >
                  </div>
                  <el-option
                    v-for="item in lineData"
                    :key="item.ID"
                    :label="item.NAME"
                    :value="item.ID"
                  >
                    <span style="float: left">{{ item.NAME }}</span>
                  </el-option>
                  <div
                    style="
                      width: 600px;
                      position: sticky;
                      bottom: 6px;
                      background: #fff;
                      z-index: 90;
                      padding-left: 15px;
                    "
                  >
                    <el-pagination
                      :pager-count="5"
                      :current-page="formData.Page"
                      :page-size="formData.Limit"
                      :page-sizes="[10, 20, 30, 40]"
                      layout="total, sizes, prev, pager, next, jumper"
                      :total="formDataPage"
                      @size-change="modelSizeChange"
                      @current-change="modelCurrentChange"
                    />
                  </div>
                </el-select>
              </el-form-item>
            </el-form>
          </el-tab-pane>
          <el-tab-pane :label="$t('_kanban._56')">
            <el-form :model="formData" label-width="80px" :show-message="false">
              <el-form-item :label="'制程'">
                <el-select
                  multiple
                  @change="changeModel"
                  v-model="formData.ROUTE_ID"
                  style="width: 100%"
                  :placeholder="$t(' ')"
                >
                  <div
                    style="
                      position: absolute;
                      width: 100%;
                      height: 6px;
                      background: #fff;
                      background: #fff;
                      top: 0;
                      z-index: 99;
                    "
                  ></div>
                  <div
                    style="
                      position: absolute;
                      width: 100%;
                      height: 6px;
                      background: #fff;
                      background: #fff;
                      bottom: 0;
                      z-index: 99;
                    "
                  ></div>
                  <div
                    style="
                      width: 600px;
                      display: flex;
                      padding: 0 20px 0 10px;
                      position: sticky;
                      top: 6px;
                      background: #fff;
                      z-index: 90;
                    "
                  >
                    <el-input
                      v-model="formData.Key"
                      @input="searchLine"
                      @keyup.enter.native="searchLine"
                    ></el-input>
                    <el-button
                      type="primary"
                      icon="el-icon-search"
                      @click.prevent="searchLine"
                      >{{ $t("publics.btn.search") }}</el-button
                    >
                  </div>
                  <el-option
                    v-for="item in ProcessData"
                    :key="item.ID"
                    :label="item.NAME"
                    :value="item.ID"
                  >
                    <span style="float: left">{{ item.NAME }}</span>
                  </el-option>
                  <div
                    style="
                      width: 600px;
                      position: sticky;
                      bottom: 6px;
                      background: #fff;
                      z-index: 90;
                      padding-left: 15px;
                    "
                  >
                    <el-pagination
                      :pager-count="5"
                      :current-page="formData.Page"
                      :page-size="formData.Limit"
                      :page-sizes="[10, 20, 30, 40]"
                      layout="total, sizes, prev, pager, next, jumper"
                      :total="formDataPage"
                      @size-change="modelSizeChange"
                      @current-change="modelCurrentChange"
                    />
                  </div>
                </el-select>
              </el-form-item>
            </el-form>
          </el-tab-pane>
        </el-tabs>
      </el-col>
      <el-col :span="7" style="height: 100%">
        <el-card style="height: 100%">
          <el-checkbox-group v-model="checkList" @change="changeBox">
            <el-checkbox label="0" disabled>{{
              $t("_kanban._26")
            }}</el-checkbox>
            <el-checkbox label="1" v-show="formData.TYPE == 2">{{
              $t("_kanban._27")
            }}</el-checkbox>
          </el-checkbox-group>
          <el-form
            ref="formData"
            :model="formData"
            label-position="left"
            label-width="80px"
          >
            <el-form-item :label="$t('_kanban._28')">
              <el-date-picker
                style="width: 100%"
                v-model="echartForm.BEGIN_TIME"
                type="datetime"
                :placeholder="$t('_kanban._29')"
              />
            </el-form-item>
            <el-form-item :label="$t('_kanban._30')">
              <el-date-picker
                style="width: 100%"
                v-model="echartForm.END_TIME"
                type="datetime"
                :placeholder="$t('_kanban._31')"
              />
            </el-form-item>
            <el-button
              style="width: 100%"
              type="primary"
              icon="el-icon-search"
              @click.prevent="getSiteStatisticsDataTable(0)"
              >{{ $t("srr._4") }}</el-button
            >
            <el-button
              style="width: 100%; margin: 10px 0 0 0"
              type="primary"
              icon="el-icon-search"
              @click.prevent="getSiteStatisticsDataTable(1)"
              >{{ $t("_kanban._57") }}</el-button
            >
            <el-button
              style="width: 100%; margin: 10px 0 0 0"
              type="info"
              icon="el-icon-s-order"
              @click.prevent="exportEvent"
              >{{ $t("publics.btn.export") }}</el-button
            >
          </el-form>
        </el-card>
      </el-col>
    </el-row>
    <!-- 下 -->
    <el-row style="height: 58%; margin-top: 10px">
      <el-tabs
        v-model="eIndex"
        @tab-click="handleClick"
        class="tabHeight"
        type="border-card"
        ref="tableTransfer"
      >
        <el-tab-pane :label="$t('_kanban._58')">
          <div
            ref="Histogram"
            id="Histogram"
            :style="{ height: tableHeight2 }"
          />
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._59')">
          <div
            ref="PassPieChart"
            id="PassPieChart"
            :style="{ height: tableHeight2 }"
          />
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._60')">
          <div
            ref="RepassPieChart"
            id="RepassPieChart"
            :style="{ height: tableHeight2 }"
          />
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._61')">
          <div
            ref="FailPieChart"
            id="FailPieChart"
            :style="{ height: tableHeight2 }"
          />
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._62')">
          <div
            ref="ReFailPieChart"
            id="ReFailPieChart"
            :style="{ height: tableHeight2 }"
          />
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._34')">
          <div style="height: 100%">
            <el-table
              ref="xTableData"
              id="xTableData"
              border
              resizable
              :height="tableHeight2"
              size="medium"
              align="center"
              show-overflow
              auto-resize
              keep-source
              :data="mainTable1"
            >
              <el-table-column
                min-width="120"
                prop="OPERATION_NAME"
                :label="$t('_kanban._38')"
              />
              <el-table-column min-width="120" prop="PASS" :label="'PASS'" />
              <el-table-column min-width="120" prop="FAIL" :label="'FAIL'" />
              <el-table-column
                min-width="120"
                prop="REPASS"
                :label="'REPASS'"
              />
              <el-table-column
                min-width="120"
                prop="REFAIL"
                :label="'REFAIL'"
              />
              <el-table-column min-width="120" prop="YIELD" :label="'YIELD'" />
              <el-table-column min-width="120" prop="TOTAL" :label="'TOTAL'" />
            </el-table>
          </div>
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._48')">
          <vxe-table
            ref="xTable2"
            border
            resizable
            :height="tableHeight2"
            size="medium"
            align="center"
            highlight-current-row
            highlight-hover-row
            show-overflow
            auto-resize
            keep-source
            :data="mainTable2"
            :mouse-config="{ selected: true }"
            :edit-config="{ trigger: 'click', mode: 'row', showStatus: true }"
            :radio-config="{ labelField: 'name', trigger: 'row' }"
            :checkbox-config="{ checkField: 'checked', trigger: 'row' }"
          >
            <vxe-table-column
              min-width="100"
              field="OPERATION_NAME"
              :title="$t('_kanban._38')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="WORK_TIME"
              :title="$t('_kanban._63')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="OPERATION_SITE_NAME"
              :title="$t('_kanban._64')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="MODEL"
              :title="$t('_kanban._18')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="WO_NO"
              :title="$t('_kanban._42')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="PASS"
              :title="'PASS'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="FAIL"
              :title="'FAIL'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="REPASS"
              :title="'REPASS'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="REFAIL"
              :title="'REFAIL'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="YIELD"
              :title="'YIELD'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
          </vxe-table>
        </el-tab-pane>
        <el-tab-pane :label="$t('_kanban._65')">
          <vxe-table
            ref="xTable3"
            border
            resizable
            :height="tableHeight2"
            size="medium"
            align="center"
            highlight-current-row
            highlight-hover-row
            show-overflow
            auto-resize
            keep-source
            :data="mainTable3"
            :mouse-config="{ selected: true }"
            :edit-config="{ trigger: 'click', mode: 'row', showStatus: true }"
            :radio-config="{ labelField: 'name', trigger: 'row' }"
            :checkbox-config="{ checkField: 'checked', trigger: 'row' }"
          >
            <vxe-table-column
              min-width="100"
              field="OPERATION_NAME"
              :title="$t('_kanban._38')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="WORK_TIME"
              :title="$t('_kanban._63')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="OPERATION_SITE_NAME"
              :title="$t('_kanban._64')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="MODEL"
              :title="$t('_kanban._18')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="WO_NO"
              :title="$t('_kanban._42')"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="PASS"
              :title="'PASS'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="FAIL"
              :title="'FAIL'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="REPASS"
              :title="'REPASS'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="REFAIL"
              :title="'REFAIL'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
            <vxe-table-column
              min-width="100"
              field="YIELD"
              :title="'YIELD'"
              :edit-render="{ name: '$input', props: { readonly: true } }"
            />
          </vxe-table>
        </el-tab-pane>
      </el-tabs>
    </el-row>
    <!-- 弹框 -->
    <el-dialog
      v-dialogDrag
      :title="$t('_kanban._48')"
      :visible.sync="dialogFormVisible"
      width="70%"
      class="Dialog"
      :close-on-click-modal="false"
    >
      <el-card class="box-card">
        <div slot="header" class="clearfix">
          <el-radio-group
            v-model="radioDetailOptions"
            @change="changeDetailOptions"
            style="padding: 20px"
          >
            <el-radio :label="0">ALL</el-radio>
            <el-radio :label="4">Group by Site</el-radio>
            <el-radio :label="6">Group by WO,PN</el-radio>
            <el-radio :label="10">Order by Site</el-radio>

            <el-radio :label="1">Group by Model</el-radio>
            <el-radio :label="5">Group by Time</el-radio>
            <el-radio :label="7">Order by Model</el-radio>
            <el-radio :label="11">Order by Time</el-radio>

            <el-radio :label="2">Group by PN</el-radio>
            <el-radio :label="3">Group by WO</el-radio>
            <el-radio :label="8">Order by PN</el-radio>
            <el-radio :label="9">Order by WO</el-radio>
          </el-radio-group>
          <el-button
            type="primary"
            icon="el-icon-s-order"
            @click.prevent="exportClick"
            >{{ $t("publics.btn.export") }}</el-button
          >
        </div>
        <el-table
          ref="xTablex"
          id="xTablex"
          border
          resizable
          :height="tableHeight2"
          size="medium"
          align="center"
          show-overflow
          auto-resize
          keep-source
          :data="DetailData"
        >
          <el-table-column
            min-width="150"
            prop="MODEL"
            :label="$t('_kanban._18')"
          />
          <el-table-column
            min-width="150"
            prop="WO_NO"
            :label="$t('_kanban._42')"
          />
          <el-table-column
            min-width="150"
            prop="PART_NO"
            :label="$t('_kanban._20')"
          />
          <el-table-column
            min-width="150"
            prop="OPERATION_SITE_NAME"
            :label="$t('_kanban._64')"
          />
          <el-table-column
            min-width="160"
            prop="WORK_TIME"
            :label="$t('_kanban._51')"
          />
          <el-table-column min-width="100" prop="PASS" :label="'PASS'" />
          <el-table-column min-width="100" prop="FAIL" :label="'FAIL'" />
          <!-- <el-table-column
            min-width="120"
            prop="MODEL"
            :label="$t('_kanban._18')"
          /> -->
          <el-table-column min-width="100" prop="REPASS" :label="'REPASS'" />
          <el-table-column min-width="100" prop="REFAIL" :label="'REFAIL'" />
          <el-table-column min-width="100" prop="YIELD" :label="'YIELD'" />
        </el-table>
      </el-card>
    </el-dialog>
  </d2-container>
</template>

<script>
import {
  GetSiteStatisticsConditionList,
  GetSiteStatisticsDataTable,
  GetSiteStatisticsDetail,
  GetSiteStatisticsReportDetail
} from '@/api/SiteStatisticsReport'
import dayjs from 'dayjs'
import echarts from 'echarts'
import XLSX from 'xlsx'
import downloadjs from 'downloadjs'
export default {
  name: 'SiteStatisticsReport',
  components: {},
  data () {
    return {
      formData: {
        Limit: 10,
        Page: 1,
        TYPE: 0
      },
      echartForm: {
        ALL: false,
        MODEL: [],
        PART_NO: [],
        WO_NO: [],
        LINE_ID: [],
        ROUTE_ID: [],
        BEGIN_TIME: '',
        END_TIME: '',
        WITHOUTRMAWO: false,
        HOURDETAIL: false,
        ISPRODUCT: true,
        ISLAGTIME: false
      },
      tableHeight2: '300px',
      tableHeight: '200px',
      screenHeight: document.body.clientHeight,
      modelData: [],
      formDataPage: 0,
      checked: true,
      eIndex: 0,
      radioTime: null,
      radioDetailOptions: 0,
      mainTable1: [],
      mainTable2: [],
      mainTable3: [],
      dialogFormVisible: false,
      DetailData: [],
      DetailForm: {
        CONDITION: 0,
        OPERATION_NAME: '',
        ALL: true,
        MODEL: [],
        PART_NO: [],
        WITHOUTRMAWO: true,
        WO_NO: [],
        LINE_ID: [],
        BEGIN_TIME: '',
        END_TIME: '',
        ISLAGTIME: false
      },
      checkList: ['0'],
      lineData: [],
      ProcessData: [],
      isAll: true,
      printName: ''
    }
  },

  watch: {
    screenHeight (val) {
      if (!this.timer) {
        this.screenHeight = val
        this.tableHeight = this.$refs.bigTabs.$el.offsetHeight - 70 + 'px'
        this.tableHeight2 =
          this.$refs.tableTransfer.$el.offsetHeight - 70 + 'px'
        this.timer = true
        let that = this
        setTimeout(function () {
          // console.log(that.screenHeight)
          that.timer = false
        }, 400)
      }
    },
    modelData (val) {
      if (val.length === 0) {
        this.modelData.push({
          ID: '',
          NAME: '',
          R: '',
          disabled: true
        })
      }
    }
  },
  methods: {
    async getSiteStatisticsDataTable (e) {
      var that = this
      // console.log('that.formData.TYPE', that.formData.TYPE)
      if (this.radioTime || this.radioTime === 0) {
        this.echartForm.ISLAGTIME = true
        this.echartForm.LAGTIME = parseInt(this.radioTime)
      }
      // 是否全部
      this.echartForm.ALL = this.formData.TYPE === 0
      if (that.formData.TYPE === 1) {
        that.echartForm.MODEL = that.formData.MODEL ? that.formData.MODEL : []
        that.echartForm.LINE_ID = that.formData.LINE_ID
          ? that.formData.LINE_ID
          : []
        that.echartForm.ROUTE_ID = that.formData.ROUTE_ID
          ? that.formData.ROUTE_ID
          : []
        if (that.echartForm.MODEL.length === 0) {
          return this.$message.error(this.$t('_kanban._52'))
        }
      } else if (that.formData.TYPE === 2) {
        that.echartForm.PART_NO = that.formData.PART_NO
          ? that.formData.PART_NO
          : []
        that.echartForm.LINE_ID = that.formData.LINE_ID
          ? that.formData.LINE_ID
          : []
        that.echartForm.ROUTE_ID = that.formData.ROUTE_ID
          ? that.formData.ROUTE_ID
          : []
        if (that.echartForm.PART_NO.length === 0) {
          return this.$message.error(this.$t('_kanban._52'))
        }
      } else if (that.formData.TYPE === 3) {
        that.echartForm.WO_NO = that.formData.WO_NO ? that.formData.WO_NO : []
        that.echartForm.LINE_ID = that.formData.LINE_ID
          ? that.formData.LINE_ID
          : []
        that.echartForm.ROUTE_ID = that.formData.ROUTE_ID
          ? that.formData.ROUTE_ID
          : []
        if (that.echartForm.WO_NO.length === 0) {
          return this.$message.error(this.$t('_kanban._52'))
        }
      } else if (that.formData.TYPE === 4) {
        that.echartForm.LINE_ID = that.formData.LINE_ID
          ? that.formData.LINE_ID
          : []
        that.echartForm.MODEL = that.formData.MODEL ? that.formData.MODEL : []
        that.echartForm.PART_NO = that.formData.PART_NO
          ? that.formData.PART_NO
          : []
        that.echartForm.WO_NO = that.formData.WO_NO ? that.formData.WO_NO : []
      } else if (that.formData.TYPE === 5) {
        that.echartForm.ROUTE_ID = that.formData.ROUTE_ID
          ? that.formData.ROUTE_ID
          : []
        that.echartForm.MODEL = that.formData.MODEL ? that.formData.MODEL : []
        that.echartForm.PART_NO = that.formData.PART_NO
          ? that.formData.PART_NO
          : []
        that.echartForm.WO_NO = that.formData.WO_NO ? that.formData.WO_NO : []
      }
      if (e === 0) {
        const res = await GetSiteStatisticsDataTable(this.echartForm)
        if (res.Result) {
          that.mainTable1 = res.Result
          that.mainTable1 = that.mainTable1.map((item) => {
            if (item.YIELD % 1 !== 0) {
              item.YIELD = item.YIELD.toFixed(2)
            }
            return item
          })
          if (that.eIndex === '0') {
            // 柱状图
            that.getHistogram(that.mainTable1)
          } else if (that.eIndex === '1') {
            // pass饼状图
            that.getPassPieChart(that.mainTable1)
          } else if (that.eIndex === '2') {
            // repass饼状图
            that.getRepassPieChart(that.mainTable1)
          } else if (that.eIndex === '3') {
            // fail饼状图
            that.getFailPieChart(that.mainTable1)
          } else if (that.eIndex === '4') {
            // refail饼状图
            that.getReFailPieChart(that.mainTable1)
          }
        }
      } else if (e === 1) {
        that.echartForm.HOURDETAIL = that.eIndex === '7'
        const res = await GetSiteStatisticsDetail(that.echartForm)
        if (that.eIndex === '6') {
          that.mainTable2 = res.Result ? res.Result : []
          console.log('that.mainTable2:', that.mainTable2)
        } else if (that.eIndex === '7') {
          that.mainTable3 = res.Result ? res.Result : []
          console.log('that.mainTable3:', that.mainTable3)
        }
      }
    },
    changeBox (e) {
      this.echartForm.WITHOUTRMAWO = this.checkList.length === 2
      this.DetailForm.WITHOUTRMAWO = this.checkList.length === 2
    },
    searchLine () {
      this.formData.Page = 1
      this.ChangeBigTab()
    },
    async ChangeBigTab (e) {
      this.formData.Page = 1
      if (e.index === '1') {
        this.formData.TYPE = 4
        const res = await GetSiteStatisticsConditionList(this.formData)
        this.formDataPage = res.Result.count ? res.Result.count : 0
        this.lineData = res.Result.data ? res.Result.data : []
      } else if (e.index === '2') {
        this.formData.TYPE = 5
        const res = await GetSiteStatisticsConditionList(this.formData)
        this.formDataPage = res.Result.count ? res.Result.count : 0
        this.ProcessData = res.Result.data ? res.Result.data : []
      }
    },
    ChangeTab (e) {
      this.cleanClick()
      this.formData.TYPE = parseInt(e.index)
      if (this.formData.TYPE === 0) return
      this.getSiteStatisticsConditionList()
    },
    async getSiteStatisticsConditionList () {
      const res = await GetSiteStatisticsConditionList(this.formData)
      this.modelData = res.Result.data ? res.Result.data : []
      if (this.formData.TYPE === 4) {
        this.lineData = res.Result.data ? res.Result.data : []
      } else if (this.formData.TYPE === 5) {
        this.ProcessData = res.Result.data ? res.Result.data : []
      }
      console.log('modelData:', this.modelData)
      this.formDataPage = res.Result.count ? res.Result.count : 0
    },
    // 清除
    cleanClick () {
      this.formData = {
        Page: 1,
        Limit: 10,
        TYPE: 0
      }
      // const now = new Date()
      this.echartForm = {
        ALL: false,
        MODEL: [],
        PART_NO: [],
        WO_NO: [],
        LINE_ID: [],
        ROUTE_ID: [],
        BEGIN_TIME: this.echartForm.BEGIN_TIME,
        END_TIME: this.echartForm.END_TIME,
        WITHOUTRMAWO: false,
        HOURDETAIL: false,
        ISPRODUCT: true,
        ISLAGTIME: false
      }
      this.DetailForm = {
        CONDITION: 0,
        OPERATION_NAME: '',
        ALL: true,
        MODEL: [],
        PART_NO: [],
        WITHOUTRMAWO: true,
        WO_NO: [],
        LINE_ID: [],
        BEGIN_TIME: '',
        END_TIME: '',
        ISLAGTIME: false
      }
      this.checkList = ['0']
      this.echartForm.WITHOUTRMAWO = this.checkList.length === 2
      this.DetailForm.WITHOUTRMAWO = this.checkList.length === 2
    },
    searchClick () {
      this.formData.Page = 1
      this.getSiteStatisticsConditionList()
    },
    // 导出数据
    exportEvent () {
      let wb = XLSX.utils.table_to_book(document.querySelector('#xTableData'))
      /* get binary string as output */
      let wbout = XLSX.write(wb, {
        bookType: 'xlsx',
        bookSST: true,
        type: 'array'
      })
      downloadjs(wbout, `${this.$t('_kanban,_53')}.xlsx`)
    },
    modelSizeChange (Limit) {
      this.formData.Limit = Limit
      this.getSiteStatisticsConditionList()
    },
    modelCurrentChange (Page) {
      this.formData.Page = Page
      this.getSiteStatisticsConditionList()
    },
    changeModel (e) {
      console.log(e)
    },
    handleClick (e) {
      // console.log('e', e)
      this.eIndex = e.index
      if (this.eIndex !== '6' && this.eIndex !== '7') {
        this.getSiteStatisticsDataTable(0)
      } else {
        this.getSiteStatisticsDataTable(1)
      }
    },
    // 超时时间
    changeTime (e) {
      console.log('单选', e)
      this.radioTime = e
      // this.getTimeoutStatistics(e)
    },
    changeDetailOptions (e) {
      this.DetailForm.CONDITION = e || 0
      this.getSiteStatisticsReportDetail()
    },
    // 弹窗查询
    async getSiteStatisticsReportDetail () {
      this.DetailForm.BEGIN_TIME = this.echartForm.BEGIN_TIME
      this.DetailForm.END_TIME = this.echartForm.END_TIME
      this.DetailForm.ALL = this.formData.TYPE === 0
      if (this.radioTime || this.radioTime === 0) {
        this.DetailForm.ISLAGTIME = true
        this.DetailForm.LAGTIME = parseInt(this.radioTime)
      }
      this.DetailForm.ALL = this.formData.TYPE === 0
      if (this.formData.TYPE === 1) {
        this.DetailForm.MODEL = this.formData.MODEL ? this.formData.MODEL : []
      } else if (this.formData.TYPE === 2) {
        this.DetailForm.PART_NO = this.formData.PART_NO
          ? this.formData.PART_NO
          : []
      } else if (this.formData.TYPE === 3) {
        this.DetailForm.WO_NO = this.formData.WO_NO ? this.formData.WO_NO : []
      }
      // else if (this.eIndex === '4') {
      //   this.DetailForm.LINE_ID = this.formData.LINE_ID? this.formData.LINE_ID
      //     : []
      // }
      const res = await GetSiteStatisticsReportDetail(this.DetailForm)
      this.DetailData = res.Result ? res.Result : []
    },
    // 明细导出
    exportClick () {
      let wb = XLSX.utils.table_to_book(document.querySelector('#xTablex')) //
      /* get binary string as output */
      let wbout = XLSX.write(wb, {
        bookType: 'xlsx',
        bookSST: true,
        type: 'array'
      })
      downloadjs(wbout, `${this.printName}${this.$t('_kanban.48')}.xlsx`)
    },
    // 柱状图
    async getHistogram (data) {
      console.log('data:', data)
      if (data.length !== 0) {
        let arrX = Object.keys(data[0])
        console.log(arrX)
        let InputArr = []
        let OutputArr = []
        let WipQtyArr = []
        data.map(item => {
          InputArr.push(item.TOTAL)
          OutputArr.push(item.PASS)
          WipQtyArr.push(item.FAIL)
        })
        this.HistogramCheart = echarts.init(
          document.getElementById('Histogram')
        )
        var optionHistogram = null
        optionHistogram = {
          color: ['#67C23A', '#F56C6C', 'green', 'red', '#409EFF'],
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              // 坐标轴指示器，坐标轴触发有效
              type: 'shadow' // 默认为直线，可选为：'line' | 'shadow'
            }
          },
          toolbox: {
            feature: {
              magicType: { show: true, type: ['line', 'bar'] }
            }
          },
          grid: {
            // left: '3%',
            // right: '4%',
            // bottom: '3%',
            // containLabel: true
          },
          dataZoom: [
            {
              show: true,
              realtime: true,
              start: 0,
              end: 100
            },
            {
              type: 'inside',
              realtime: true,
              start: 0,
              end: 100
            }
          ],
          legend: {
            data: [
              'OPERATION_NAME',
              'PASS',
              'FAIL',
              'REPASS',
              'REFAIL',
              'YIELD',
              'Input',
              'Output',
              'WipQty'
            ]
          },
          dataset: {
            dimensions: [
              'OPERATION_NAME',
              'PASS',
              'FAIL',
              'REPASS',
              'REFAIL',
              'YIELD',
              'TOTAL',
              'PASS',
              'FAIL'

            ],
            source: data
          },
          xAxis: {
            type: 'category'
            // axisLabel: {
            //   interval: 0,
            //   rotate: 40
            // },
          },
          yAxis: {
            // type: 'value'
          },
          series: [
            {
              name: 'Input',
              type: 'line',
              data: InputArr
            },
            {
              name: 'Output',
              type: 'line',
              data: OutputArr
            },
            {
              name: 'WipQty',
              type: 'line',
              data: WipQtyArr
            },
            {
              type: 'bar',
              itemStyle: {
                normal: {
                  label: {
                    show: true, // 开启显示
                    position: 'top', // 在上方显示
                    textStyle: {
                      // 数值样式
                      color: '#606266',
                      fontSize: 14
                    }
                  }
                }
              }
            },
            {
              type: 'bar',
              itemStyle: {
                normal: {
                  label: {
                    show: true, // 开启显示
                    position: 'top', // 在上方显示
                    textStyle: {
                      // 数值样式
                      color: '#606266',
                      fontSize: 14
                    }
                  }
                }
              }
            },
            {
              type: 'bar',
              itemStyle: {
                normal: {
                  label: {
                    show: true, // 开启显示
                    position: 'top', // 在上方显示
                    textStyle: {
                      // 数值样式
                      color: '#606266',
                      fontSize: 14
                    }
                  }
                }
              }
            },
            {
              type: 'bar',
              itemStyle: {
                normal: {
                  label: {
                    show: true, // 开启显示
                    position: 'top', // 在上方显示
                    textStyle: {
                      // 数值样式
                      color: '#606266',
                      fontSize: 14
                    }
                  }
                }
              }
            },
            {
              type: 'bar',
              itemStyle: {
                normal: {
                  label: {
                    show: true, // 开启显示
                    position: 'top', // 在上方显示
                    textStyle: {
                      // 数值样式
                      color: '#606266',
                      fontSize: 14
                    }
                  }
                }
              }
            }
          ]
        }
        this.HistogramCheart.hideLoading() // 隐藏加载动画
        this.HistogramCheart.setOption(optionHistogram, true)
        this.HistogramCheart.resize()
        this.HistogramCheart.on('click', (params) => {
          // console.log(params)
          this.DetailForm.OPERATION_ID = params.value.OPERATION_ID

          this.printName = params.name
          this.getSiteStatisticsReportDetail(params)
          this.dialogFormVisible = true
        })
        window.onresize = () => {
          this.HistogramCheart.resize()
        }
      } else {
        this.HistogramCheart.clear()
      }
    },
    // pass饼状图
    async getPassPieChart (data) {
      if (data.length !== 0) {
        let arrX = []
        let arrY = []
        await data.map((item, index) => {
          arrX.push(item.OPERATION_NAME)
          arrY.push({ value: item.PASS, name: item.OPERATION_NAME })
        })
        console.log(arrX)
        console.log(arrY)
        this.PassPieChart = echarts.init(
          document.getElementById('PassPieChart')
        )
        var optionPassPieChart = null
        optionPassPieChart = {
          title: {
            // text: '某站点用户访问来源',
            // subtext: '纯属虚构',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: '{b} : {c} ({d}%)'
          },
          legend: {
            orient: 'vertical',
            left: 'left',
            data: arrX,
            formatter: (name) => {
              const res = arrY.find((i) => i && i.name === name)
              return res.name + '     ' + res.value
            }
          },
          series: [
            {
              // name: '访问来源',
              type: 'pie',
              radius: '80%',
              center: ['50%', '60%'],
              data: arrY,
              label: {
                formatter: '{b} : {c} ({d}%)'
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        }
        this.PassPieChart.hideLoading() // 隐藏加载动画
        this.PassPieChart.setOption(optionPassPieChart, true)
        this.PassPieChart.resize()

        window.onresize = () => {
          this.PassPieChart.resize()
        }
      } else {
        this.PassPieChart.clear()
      }
    },
    // repass饼状图
    async getRepassPieChart (data) {
      if (data.length !== 0) {
        let arrX = []
        let arrY = []
        await data.map((item, index) => {
          arrX.push(item.OPERATION_NAME)
          arrY.push({ value: item.REPASS, name: item.OPERATION_NAME })
        })
        this.RepassPieChart = echarts.init(
          document.getElementById('RepassPieChart')
        )
        var optionRepassPieChart = null
        optionRepassPieChart = {
          title: {
            // text: '某站点用户访问来源',
            // subtext: '纯属虚构',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b} : {c} ({d}%)'
          },
          legend: {
            orient: 'vertical',
            left: 'left',
            data: arrX,
            formatter: (name) => {
              const res = arrY.find((i) => i && i.name === name)
              return res.name + '     ' + res.value
            }
          },
          series: [
            {
              // name: '访问来源',
              type: 'pie',
              radius: '80%',
              center: ['50%', '60%'],
              data: arrY,
              label: {
                formatter: '{b} : {c} ({d}%)'
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        }
        this.RepassPieChart.hideLoading() // 隐藏加载动画
        this.RepassPieChart.setOption(optionRepassPieChart, true)
        this.RepassPieChart.resize()
        window.onresize = () => {
          this.RepassPieChart.resize()
        }
      } else {
        this.RepassPieChart.clear()
      }
    },
    // fail饼状图
    async getFailPieChart (data) {
      if (data.length !== 0) {
        let arrX = []
        let arrY = []
        await data.map((item, index) => {
          arrX.push(item.OPERATION_NAME)
          arrY.push({ value: item.FAIL, name: item.OPERATION_NAME })
        })
        this.FailPieChart = echarts.init(
          document.getElementById('FailPieChart')
        )
        var optionFailPieChart = null
        optionFailPieChart = {
          title: {
            // text: '某站点用户访问来源',
            // subtext: '纯属虚构',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b} : {c} ({d}%)'
          },
          legend: {
            orient: 'vertical',
            left: 'left',
            data: arrX,
            formatter: (name) => {
              const res = arrY.find((i) => i && i.name === name)
              return res.name + '     ' + res.value
            }
          },
          series: [
            {
              // name: '访问来源',
              type: 'pie',
              radius: '80%',
              center: ['50%', '60%'],
              data: arrY,
              label: {
                formatter: '{b} : {c} ({d}%)'
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        }
        this.FailPieChart.hideLoading() // 隐藏加载动画
        this.FailPieChart.setOption(optionFailPieChart, true)
        this.FailPieChart.resize()
        window.onresize = () => {
          this.FailPieChart.resize()
        }
      } else {
        this.FailPieChart.clear()
      }
    },
    // refail饼状图
    async getReFailPieChart (data) {
      if (data.length !== 0) {
        let arrX = []
        let arrY = []
        await data.map((item, index) => {
          arrX.push(item.OPERATION_NAME)
          arrY.push({ value: item.REFAIL, name: item.OPERATION_NAME })
        })
        this.ReFailPieChart = echarts.init(
          document.getElementById('ReFailPieChart')
        )
        var optionReFailPieChart = null
        optionReFailPieChart = {
          title: {
            // text: '某站点用户访问来源',
            // subtext: '纯属虚构',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b} : {c} ({d}%)'
          },
          legend: {
            orient: 'vertical',
            left: 'left',
            data: arrX,
            formatter: (name) => {
              const res = arrY.find((i) => i && i.name === name)
              return res.name + '     ' + res.value
            }
          },
          series: [
            {
              // name: '访问来源',
              type: 'pie',
              radius: '80%',
              center: ['50%', '60%'],
              data: arrY,
              label: {
                formatter: '{b} : {c} ({d}%)'
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        }
        this.ReFailPieChart.hideLoading() // 隐藏加载动画
        this.ReFailPieChart.setOption(optionReFailPieChart, true)
        this.ReFailPieChart.resize()
        window.onresize = () => {
          this.ReFailPieChart.resize()
        }
      } else {
        this.ReFailPieChart.clear()
      }
    }
  },
  created () {
    // this.echartForm.BEGIN_TIME = dayjs().format('YYYY-MM-DD HH:mm:ss ')
    // this.echartForm.END_TIME = dayjs().format('YYYY-MM-DD HH:mm:ss ')
    this.echartForm.BEGIN_TIME = dayjs().subtract(24, 'hour')
    this.echartForm.END_TIME = dayjs().add(24, 'hour')
    this.echartForm.BEGIN_TIME = this.echartForm.BEGIN_TIME.$d
    this.echartForm.END_TIME = this.echartForm.END_TIME.$d
    // console.log(, 'this.echartForm.BEGIN_TIME')
  },
  mounted () {
    const that = this
    window.onresize = () => {
      return (() => {
        window.screenHeight = document.body.clientHeight
        that.screenHeight = window.screenHeight
      })()
    }
    this.$nextTick(() => {
      this.tableHeight = this.$refs.bigTabs.$el.offsetHeight - 70 + 'px'
      this.tableHeight2 = this.$refs.tableTransfer.$el.offsetHeight - 70 + 'px'
    })
  }
}
</script>

<style lang="scss" scoped>
.tabHeight {
  height: 100%;
}
.siteManagerReport .el-radio {
  margin: 0;
}
</style>
<style>
.siteManagerReport .el-tabs--border-card {
  height: 100%;
}
.siteManagerReport .el-card.is-always-shadow {
  height: 100%;
}
.siteManagerReport .el-col-8 {
  height: 100%;
}
.siteManagerReport .el-radio {
  width: 25%;
}
.siteManagerReport .el-tabs--border-card > .el-tabs__content {
  padding: 10px;
}
</style>
